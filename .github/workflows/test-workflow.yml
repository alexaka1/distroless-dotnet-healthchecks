name: Tests workflow
on:
  workflow_call:
    inputs:
      runs-on:
        description: "Runner to use for tests"
        type: string
        required: true
      platform:
        description: "Platform architecture (amd64, arm64)"
        type: string
        required: true
      base-image-type:
        description: "Base image type to use for healthcheck"
        type: string
        required: false
        default: ubuntu-chiseled
      healthcheck_image:
        description: "Full image reference to use for healthcheck (e.g., foo/bar:tag@sha256:...)"
        type: string
        required: true
      healthcheck_artifact:
        description: "Artifact name to download for healthcheck image"
        type: string
        required: false


permissions: { }

env:
  DOTNET_NOLOGO: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
  CI: 'true'
  TESTINGPLATFORM_TELEMETRY_OPTOUT: '1'

jobs:
  enumerate-tests:
    if: ${{ inputs.base-image-type == 'ubuntu-chiseled' }}
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      chunk-0: ${{ steps.split-tests.outputs.chunk-0 }}
      chunk-1: ${{ steps.split-tests.outputs.chunk-1 }}
      chunk-2: ${{ steps.split-tests.outputs.chunk-2 }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: audit
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Setup Dotnet
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
        with:
          dotnet-version: |
            10.0.x
      - name: Enumerate tests
        id: enumerate
        run: |
          # Build the test project first
          dotnet build test/Distroless.HealthChecks.Test/Distroless.HealthChecks.Test.csproj --configuration Release
          
          # Enumerate all tests with theory pre-enumeration, capturing only stdout
          dotnet run --project test/Distroless.HealthChecks.Test/Distroless.HealthChecks.Test.csproj \
            --configuration Release --no-build \
            -- -list full/json -preEnumerateTheories 2>/dev/null > test-output.txt
          
          # Extract JSON array more robustly - find first '[' to last ']' on valid JSON lines
          sed -n '/^\[/,/^\]/p' test-output.txt > test-list.json
          
          # Extract test IDs
          jq -r '.[].ID' test-list.json > all-test-ids.txt
          
          echo "Total tests: $(wc -l < all-test-ids.txt)"
      - name: Split tests into chunks
        id: split-tests
        run: |
          # Split test IDs into 3 roughly equal chunks
          total_tests=$(wc -l < all-test-ids.txt)
          chunk_size=$(( (total_tests + 2) / 3 ))
          
          # Create 3 chunks
          split -l "$chunk_size" all-test-ids.txt chunk-
          
          # Convert each chunk to space-separated --filter-uid arguments and set as output
          for i in 0 1 2; do
            case $i in
              0) chunk_file="chunk-aa" ;;
              1) chunk_file="chunk-ab" ;;
              2) chunk_file="chunk-ac" ;;
            esac
            
            if [ -f "$chunk_file" ]; then
              # Build --filter-uid arguments from chunk file
              ids=$(cat "$chunk_file" | sed 's/^/--filter-uid /' | tr '\n' ' ')
              # Use GitHub Actions multiline output format
              {
                echo "chunk-$i<<EOF"
                echo "$ids"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
              echo "Chunk $i: $(wc -l < "$chunk_file") tests"
            else
              echo "chunk-$i=" >> "$GITHUB_OUTPUT"
              echo "Chunk $i: 0 tests"
            fi
          done

  test-ubuntu-chiseled:
    if: ${{ inputs.base-image-type == 'ubuntu-chiseled' }}
    needs: enumerate-tests
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        chunk: [0, 1, 2]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: audit
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Download artifact
        if: ${{ inputs.healthcheck_artifact != '' }}
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ inputs.healthcheck_artifact }}
          path: ${{ runner.temp }}
      - name: Load image
        if: ${{ inputs.healthcheck_artifact != '' }}
        run: |
          docker load --input ${{ runner.temp }}/image.tar
      - name: Setup Dotnet
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
        with:
          dotnet-version: |
            10.0.x
      - name: DotNet tools restore
        run: dotnet tool restore
      - name: Build test project
        run: dotnet build test/Distroless.HealthChecks.Test/Distroless.HealthChecks.Test.csproj --configuration Release
      - name: Get test IDs for chunk
        id: get-ids
        run: |
          # Select the appropriate chunk based on matrix index
          case ${{ matrix.chunk }} in
            0) CHUNK_IDS="${{ needs.enumerate-tests.outputs.chunk-0 }}" ;;
            1) CHUNK_IDS="${{ needs.enumerate-tests.outputs.chunk-1 }}" ;;
            2) CHUNK_IDS="${{ needs.enumerate-tests.outputs.chunk-2 }}" ;;
          esac
          
          {
            echo "test-ids<<EOF"
            echo "$CHUNK_IDS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Run tests (chunk ${{ matrix.chunk }})
        run: |
          dotnet test \
            --project test/Distroless.HealthChecks.Test/Distroless.HealthChecks.Test.csproj \
            --configuration Release \
            --no-build \
            --crashdump \
            --hangdump \
            --hangdump-timeout 30m \
            --retry-failed-tests 2 \
            --retry-failed-tests-max-tests 5 \
            --report-xunit-trx \
            --max-threads 3 \
            --pre-enumerate-theories on \
            ${{ steps.get-ids.outputs.test-ids }}
        env:
          BASE_IMAGE_TYPE: ${{ inputs.base-image-type }}
          HEALTHCHECK_IMAGE: ${{ inputs.healthcheck_image }}
      - name: TRX report
        if: ${{ !cancelled() }}
        run: dotnet trx --gh-summary False --gh-comment True
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: TRX report upload
        if: ${{ failure() && !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trx-reports-${{ inputs.platform }}-ubuntu-chiseled-chunk-${{ matrix.chunk }}
          path: "./**/*.trx"
      - name: Error log
        if: ${{ failure() && !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: error-log-${{ inputs.platform }}-ubuntu-chiseled-chunk-${{ matrix.chunk }}
          path: "./**/TestResults/Distroless.*.log"

  test-alpine:
    if: ${{ inputs.base-image-type == 'alpine' }}
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: audit
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Download artifact
        if: ${{ inputs.healthcheck_artifact != '' }}
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ inputs.healthcheck_artifact }}
          path: ${{ runner.temp }}
      - name: Load image
        if: ${{ inputs.healthcheck_artifact != '' }}
        run: |
          docker load --input ${{ runner.temp }}/image.tar
      - name: Setup Dotnet
        uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
        with:
          dotnet-version: |
            10.0.x
      - name: DotNet tools restore
        run: dotnet tool restore
      - name: Run tests
        run: >-
          dotnet test
          --configuration Release
          --crashdump
          --hangdump
          --hangdump-timeout 30m
          --retry-failed-tests 2
          --retry-failed-tests-max-tests 5
          --report-xunit-trx
        env:
          BASE_IMAGE_TYPE: ${{ inputs.base-image-type }}
          HEALTHCHECK_IMAGE: ${{ inputs.healthcheck_image }}
      - name: TRX report
        if: ${{ !cancelled() }}
        run: dotnet trx --gh-summary False --gh-comment True
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: TRX report upload
        if: ${{ failure() && !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trx-reports-${{ inputs.platform }}-alpine
          path: "./**/*.trx"
      - name: Error log
        if: ${{ failure() && !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: error-log-${{ inputs.platform }}-alpine
          path: "./**/TestResults/Distroless.*.log"
